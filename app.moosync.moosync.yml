app-id: app.moosync.moosync
runtime: org.freedesktop.Platform
runtime-version: "21.08"
sdk: org.freedesktop.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.node16
base: org.electronjs.Electron2.BaseApp
base-version: "21.08"
command: moosync
rename-icon: moosync
separate-locales: false
finish-args:
  - --share=ipc
  - --socket=x11
  - --socket=pulseaudio
  - --share=network
  - --filesystem=xdg-music
  - --device=dri
  - --own-name=org.mpris.MediaPlayer2.Moosync
  - --talk-name=org.mpris.MediaPlayer2.Player
  - --talk-name=org.freedesktop.secrets
  - --talk-name=org.gnome.keyring
  - --talk-name=org.kde.kwalletd5
cleanup:
  - /include
  - /lib/girepository-1.0
  - /lib/pkgconfig
  - /lib/cmake
  - /lib/openjpeg-*
  - /lib/libhdf5.settings
  - /lib/debug
  - /man
  - /share/aclocal
  - /share/doc
  - /share/gir-1.0
  - /share/gtk-doc
  - /share/man
  - /share/pkgconfig
  - /share/aclocal*
  - /share/autoconf*
  - /share/automake*
  - /share/info
  - /share/thumbnailers
  - /share/USING_HDF5_CMake.txt
  - /share/COPYING
  - /share/RELEASE.txt
  - /share/cmake
  - /bin/a*
  - /bin/b*
  - /bin/c*
  - /bin/d*
  - /bin/e*
  - /bin/f*
  - /bin/g*
  - /bin/h*
  - /bin/i*
  - /bin/l*
  - /bin/o*
  - /bin/p*
  - /bin/r*
  - /bin/s*
  - /bin/t*
  - /bin/x*
  - /bin/vips
  - /bin/vipsheader
  - /bin/vipsedit
  - /bin/vips-*
  - /bin/vipsprofile
  - /bin/vipsthumbnail
  - "*.la"
  - "*.a"
modules:
  - name: libvips
    builddir: true
    buildsystem: autotools
    build-options:
      env:
        V: 0
    sources:
      - type: archive
        url: https://github.com/libvips/libvips/releases/download/v8.13.1/vips-8.13.1.tar.gz
        sha256: ad377b7e561bb2118de9a3864fcaa60c61ba7f47e849f6044d1b339906197702
        x-checker-data:
          type: json
          url: https://api.github.com/repos/libvips/libvips/releases/latest
          version-query: .tag_name | sub("^v"; "")
          url-query: .assets[] | select(.name=="vips-" + $version + ".tar.gz") | .browser_download_url

  - name: yarn
    buildsystem: simple
    build-commands:
      - cp -a * /app
    cleanup:
      - "*"
    sources:
      - type: archive
        url: https://github.com/yarnpkg/yarn/releases/download/v1.22.19/yarn-v1.22.19.tar.gz
        sha256: 732620bac8b1690d507274f025f3c6cfdc3627a84d9642e38a07452cc00e0f2e

  - name: Moosync
    buildsystem: simple
    build-options:
      append-path: /usr/lib/sdk/node16/bin:/app/yarn/bin
      env:
        ELECTRON_CACHE: /run/build/Moosync/flatpak-node/electron-cache
        ELECTRON_BUILDER_CACHE: /run/build/Moosync/flatpak-node/electron-cache
        PLAYWRIGHT_BROWSERS_PATH: /run/build/Moosync/flatpak-node/cache/ms-playwright
        ELECTRON_SKIP_BINARY_DOWNLOAD: 1
        npm_config_nodedir: /run/build/Moosync/flatpak-node/node-gyp/electron-current
        npm_config_runtime: electron
    sources:
      - type: archive
        url: https://github.com/Moosync/Moosync/releases/download/v5.0.1/Moosync-5.0.1-linux-x64.pacman
        sha256: 51b21a04a48801554a12e9125c28c72198143386b2506871dfcf47308b38b3f9
        dest-filename: Moosync-linux-x64.tar.xz
        dest: Moosync

      - type: git
        url: https://github.com/Moosync/Moosync.git
        # branch: dev
        tag: v5.0.1
        disable-submodules: true

      - generated-sources.json

      - type: file
        path: electron-20.patch

      - type: file
        path: better-sqlite3.patch

      - type: file
        path: app.moosync.moosync.appdata.xml

      - type: script
        dest-filename: moosync.sh
        commands:
          # TODO: Find a way to get extension-host and relaunch working with zypak
          - TMPDIR=$XDG_RUNTIME_DIR/$APP_ID/ && /app/Moosync/moosync --no-sandbox
            "$@"

    build-commands:
      # Copy prebuilt JS files
      - mv Moosync/Moosync /app/Moosync
      - install -Dm755 moosync.sh /app/bin/moosync
      - chmod +x /app/Moosync/moosync
      - install -d /app/share/applications
      - install -Dm644 Moosync/share/applications/moosync.desktop /app/share/applications/${FLATPAK_ID}.desktop
      - desktop-file-edit --set-key=Exec --set-value="/app/bin/moosync %U" /app/share/applications/${FLATPAK_ID}.desktop
      - cp -r Moosync/share/icons /app/share/icons
      - install -D app.moosync.moosync.appdata.xml --target-directory=/app/share/metainfo/

      # Remove all prebuilt native modules
      - find /app/Moosync/resources/ -name "*.node" -type f -delete

      # Build native modules
      - HOME=$PWD yarn config --offline set nodedir $FLATPAK_BUILDER_BUILDDIR/flatpak-node/node-gyp/electron-current
      - HOME=$PWD yarn config --offline set yarn-offline-mirror $FLATPAK_BUILDER_BUILDDIR/flatpak-node/yarn-mirror
      - "sed -i -e '/...archElectronConfig,/a electronDownload: { cache: \"/run/build/Moosync/flatpak-node/electron-cache\"\
        \ },' vue.config.js"

      # Fixes electron 20 build
      - git apply electron-20.patch
      - |
        cd flatpak-node/tmp/better-sqlite3.git-a0227e3fd4567ebc9683c0e21c0ac4719c51d2f7 
        git apply ../../../better-sqlite3.patch
        git add -A
        rm -f ../../yarn-mirror/better-sqlite3.git-a0227e3fd4567ebc9683c0e21c0ac4719c51d2f7
        git archive --format tar -o ../../yarn-mirror/better-sqlite3.git-a0227e3fd4567ebc9683c0e21c0ac4719c51d2f7 $(git stash create)

      - npm_config_runtime=electron ELECTRON_SKIP_BINARY_DOWNLOAD=1 PLAYWRIGHT_BROWSERS_PATH="$FLATPAK_BUILDER_BUILDDIR/flatpak-node/cache/ms-playwright" yarn install --offline
      - install -d /app/Moosync/resources/app.asar.unpacked/node_modules
      - |
        cd node_modules
        find . -name '*.node' -exec cp --parents \{\} /"/app/Moosync/resources/app.asar.unpacked/node_modules" \;
